# 腾讯云部署方案设计文档

**项目**: AI Research Assistant  
**目标平台**: 腾讯云轻量应用服务器  
**日期**: 2025-10-31  
**版本**: 1.0

---

## 📋 目录

1. [方案设计思考](#方案设计思考)
2. [架构设计](#架构设计)
3. [技术选型](#技术选型)
4. [成本分析](#成本分析)
5. [风险评估](#风险评估)
6. [实施计划](#实施计划)

---

## 🎯 方案设计思考

### 1. 为什么选择腾讯云？

#### 1.1 成本优势

**对比分析**:
```
Render Starter:  $7/月 (1GB RAM)
腾讯云轻量:      ¥32/月 (~$4.5/月, 2GB RAM)
节省:            ~35% + 性能翻倍
```

**ROI 计算**:
- 年度节省: ($7 - $4.5) × 12 = $30/年
- 性能提升: 2GB RAM vs 1GB RAM (100% 提升)
- 存储空间: 50GB vs 无限制但受限

#### 1.2 性能优势

| 指标 | Render Starter | 腾讯云轻量 | 优势 |
|------|----------------|-----------|------|
| CPU | 共享 | 2核独享 | ✅ 腾讯云 |
| RAM | 1GB | 2GB | ✅ 腾讯云 |
| 存储 | 有限 | 50GB SSD | ✅ 腾讯云 |
| 带宽 | 共享 | 3Mbps 独享 | ✅ 腾讯云 |
| 网络 | 国际 | 国内优化 | ✅ 腾讯云（国内用户）|

#### 1.3 控制优势

**完全控制权**:
- ✅ 自定义配置
- ✅ 安装任何软件
- ✅ 优化系统参数
- ✅ 直接访问日志
- ✅ 自定义监控

**vs Render 限制**:
- ❌ 配置受限
- ❌ 无法安装系统软件
- ❌ 无法优化系统
- ❌ 日志查看受限

---

### 2. 部署策略选择

#### 2.1 Docker vs 直接部署

**对比**:

| 特性 | Docker 部署 | 直接部署 |
|------|------------|---------|
| 环境一致性 | ✅ 完全一致 | ⚠️ 可能差异 |
| 部署速度 | ✅ 快速 | ⚠️ 较慢 |
| 资源占用 | ⚠️ 稍高 | ✅ 较低 |
| 易于迁移 | ✅ 容易 | ❌ 困难 |
| 学习曲线 | ⚠️ 需要学习 | ✅ 简单 |
| 隔离性 | ✅ 好 | ❌ 差 |

**决策**: 选择 **Docker 部署**

**理由**:
1. 环境一致性最重要（开发 = 生产）
2. 易于迁移和扩展
3. 隔离性好，不影响系统
4. 2GB RAM 足够运行 Docker
5. 未来可以轻松迁移到 K8s

#### 2.2 数据库策略

**选项**:

**选项 A**: 继续使用 Neon（推荐）✅
- ✅ 已经配置好
- ✅ 自动备份
- ✅ 无需维护
- ✅ 免费
- ⚠️ 网络延迟（国外）

**选项 B**: 腾讯云 PostgreSQL
- ✅ 国内访问快
- ✅ 与应用同区域
- ❌ 需要付费（¥0.24/小时 起）
- ❌ 需要配置

**选项 C**: 自建 PostgreSQL
- ✅ 完全控制
- ✅ 无额外费用
- ❌ 需要维护
- ❌ 需要备份
- ❌ 占用服务器资源

**决策**: **选项 A - 继续使用 Neon**

**理由**:
1. 已经配置好，无需迁移
2. 免费且稳定
3. 自动备份
4. 网络延迟可接受（~100-200ms）
5. 节省服务器资源

---

### 3. 架构设计原则

#### 3.1 单体 vs 微服务

**当前阶段**: 单体架构 ✅

**理由**:
- 应用规模小
- 团队规模小
- 快速迭代
- 降低复杂度

**未来演进**:
```
Phase 1: 单体应用（当前）
    ↓
Phase 2: 前后端分离
    ↓
Phase 3: 微服务化（如需要）
```

#### 3.2 高可用设计

**当前阶段**: 单实例 + 监控

**未来扩展**:
- 负载均衡
- 多实例部署
- 数据库主从
- Redis 缓存

#### 3.3 安全设计

**必须实现**:
- ✅ HTTPS（Let's Encrypt）
- ✅ 防火墙配置
- ✅ SSH 密钥认证
- ✅ 定期安全更新

**可选实现**:
- WAF（Web 应用防火墙）
- DDoS 防护
- 入侵检测

---

## 🏗️ 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────┐
│                   用户/客户端                        │
└──────────────────┬──────────────────────────────────┘
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────────────────┐
│              Nginx (反向代理 + SSL)                  │
│  - 端口 80/443                                       │
│  - SSL 证书 (Let's Encrypt)                         │
│  - 静态文件服务                                      │
│  - Gzip 压缩                                         │
└──────────────────┬──────────────────────────────────┘
                   │ HTTP
                   ▼
┌─────────────────────────────────────────────────────┐
│         Docker Container (FastAPI App)              │
│  ┌───────────────────────────────────────────────┐  │
│  │  Gunicorn (2 workers)                         │  │
│  │    ├─ Uvicorn Worker 1                        │  │
│  │    └─ Uvicorn Worker 2                        │  │
│  │                                                │  │
│  │  FastAPI Application                          │  │
│  │    ├─ /api/health                             │  │
│  │    ├─ /api/models                             │  │
│  │    ├─ /api/research/stream                    │  │
│  │    └─ /                                       │  │
│  └───────────────────────────────────────────────┘  │
│                                                      │
│  端口: 8000 (内部)                                   │
│  内存: ~600-800MB                                    │
└──────────────────┬──────────────────────────────────┘
                   │
                   ├─────────────────┐
                   │                 │
                   ▼                 ▼
┌──────────────────────────┐  ┌─────────────────────┐
│  Neon PostgreSQL         │  │  AI APIs            │
│  (外部服务)              │  │  - DeepSeek         │
│  - 数据持久化            │  │  - OpenAI           │
│  - 自动备份              │  │  - Tavily           │
└──────────────────────────┘  └─────────────────────┘
```

### 网络架构

```
Internet
    │
    ▼
[腾讯云防火墙]
    │
    ├─ 端口 80  (HTTP)  → Nginx
    ├─ 端口 443 (HTTPS) → Nginx
    ├─ 端口 22  (SSH)   → 仅允许特定 IP
    └─ 其他端口         → 全部拒绝
    │
    ▼
[服务器内部]
    │
    ├─ Nginx (80/443)
    │     │
    │     └─ 反向代理到 → Docker (8000)
    │
    └─ Docker Network
          └─ FastAPI Container (8000)
```

---

## 🔧 技术选型

### 1. 操作系统

**选择**: Ubuntu 22.04 LTS

**理由**:
- ✅ 长期支持（5年）
- ✅ 社区活跃
- ✅ 文档丰富
- ✅ 软件包齐全
- ✅ Docker 支持好

### 2. Web 服务器

**选择**: Nginx

**理由**:
- ✅ 高性能
- ✅ 低内存占用
- ✅ 反向代理
- ✅ SSL 支持
- ✅ 静态文件服务

**配置要点**:
- 反向代理到 Docker
- SSL 终止
- Gzip 压缩
- 静态文件缓存
- SSE 支持（关键！）

### 3. 应用服务器

**选择**: Gunicorn + Uvicorn Workers

**理由**:
- ✅ 生产级
- ✅ 进程管理
- ✅ 异步支持
- ✅ 自动重启
- ✅ 性能好

**配置**:
```bash
gunicorn main:app \
  --workers 2 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --timeout 120 \
  --access-logfile - \
  --error-logfile -
```

### 4. 容器化

**选择**: Docker + Docker Compose

**理由**:
- ✅ 环境一致
- ✅ 易于部署
- ✅ 隔离性好
- ✅ 易于回滚

### 5. 进程管理

**选择**: Docker (自带) + Systemd (Docker 守护)

**理由**:
- ✅ Docker 自动重启容器
- ✅ Systemd 管理 Docker 服务
- ✅ 开机自启动

### 6. 日志管理

**选择**: Docker logs + Logrotate

**理由**:
- ✅ 简单
- ✅ 自动轮转
- ✅ 易于查看

### 7. 监控

**选择**: 
- 基础: 腾讯云监控（免费）
- 进阶: Prometheus + Grafana（可选）

---

## 💰 成本分析

### 月度成本

```
服务器:
  腾讯云轻量 2核2GB:  ¥32/月

域名（可选）:
  .com 域名:          ¥55/年 ≈ ¥4.6/月
  
SSL 证书:
  Let's Encrypt:      免费

数据库:
  Neon PostgreSQL:    免费

AI API:
  DeepSeek + OpenAI:  按使用量 (~¥70-350/月)

总计:
  基础: ¥32/月
  含域名: ¥36.6/月
  含 AI API: ¥102-386.6/月
```

### 年度成本

```
服务器: ¥32 × 12 = ¥384/年
域名: ¥55/年
总计: ¥439/年 (~$62/年)

vs Render Starter:
  $7 × 12 = $84/年

节省: $84 - $62 = $22/年 (26%)
性能: 2GB vs 1GB (100% 提升)
```

---

## ⚠️ 风险评估

### 1. 技术风险

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|---------|
| Docker 配置错误 | 中 | 无法启动 | 充分测试，文档完善 |
| Nginx 配置错误 | 中 | 无法访问 | 提供模板，逐步验证 |
| 内存不足 | 低 | 性能下降 | 2GB 足够，可监控 |
| 磁盘空间不足 | 低 | 日志堆积 | 配置日志轮转 |
| 网络延迟 | 低 | 响应慢 | Neon 延迟可接受 |

### 2. 运维风险

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|---------|
| 服务器宕机 | 中 | 服务中断 | 监控告警，快速恢复 |
| 安全漏洞 | 高 | 数据泄露 | 定期更新，防火墙 |
| 误操作 | 中 | 服务中断 | 备份，文档规范 |
| 依赖更新 | 低 | 兼容性 | 测试后更新 |

### 3. 成本风险

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|---------|
| 流量超限 | 低 | 额外费用 | 监控流量，设置告警 |
| AI API 超支 | 中 | 成本增加 | 设置预算，监控使用 |
| 服务器升级 | 低 | 成本增加 | 按需升级 |

---

## 📅 实施计划

### Phase 1: 准备阶段（1 小时）

**任务**:
1. 购买腾讯云轻量服务器
2. 配置 SSH 密钥
3. 配置防火墙
4. 安装基础软件

**产出**:
- ✅ 服务器可访问
- ✅ 基础环境就绪

### Phase 2: 部署阶段（1-2 小时）

**任务**:
1. 安装 Docker
2. 克隆代码
3. 配置环境变量
4. 构建并运行容器
5. 配置 Nginx
6. 配置 SSL

**产出**:
- ✅ 应用运行
- ✅ HTTPS 可访问

### Phase 3: 优化阶段（30 分钟）

**任务**:
1. 配置日志轮转
2. 配置监控
3. 性能测试
4. 文档整理

**产出**:
- ✅ 生产就绪
- ✅ 文档完善

### Phase 4: 验证阶段（30 分钟）

**任务**:
1. 功能测试
2. 性能测试
3. 安全检查
4. 备份验证

**产出**:
- ✅ 验证通过
- ✅ 正式上线

---

## 📊 成功指标

### 性能指标

- ✅ 首页加载时间 < 2s
- ✅ API 响应时间 < 500ms
- ✅ 健康检查响应 < 100ms
- ✅ 内存使用 < 1.5GB
- ✅ CPU 使用 < 70%

### 可用性指标

- ✅ 正常运行时间 > 99%
- ✅ 错误率 < 1%
- ✅ 恢复时间 < 5 分钟

### 安全指标

- ✅ HTTPS 强制
- ✅ 防火墙配置
- ✅ SSH 密钥认证
- ✅ 定期安全更新

---

## 🎯 总结

### 方案优势

1. **成本优势**: 节省 26% 年度成本
2. **性能优势**: 2GB RAM，2核 CPU
3. **控制优势**: 完全控制权
4. **学习价值**: DevOps 实践经验

### 方案劣势

1. **运维成本**: 需要自己维护
2. **学习曲线**: 需要学习 Docker/Nginx
3. **时间投入**: 初次部署需要 2-3 小时

### 适用场景

✅ **适合**:
- 想要降低成本
- 愿意学习 DevOps
- 需要完全控制
- 国内用户为主

❌ **不适合**:
- 完全不懂技术
- 没有时间维护
- 需要零运维
- 需要自动扩展

---

**下一步**: 查看详细部署指南 `TENCENT_CLOUD_DEPLOYMENT_GUIDE.md`
