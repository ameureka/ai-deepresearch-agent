# ä¸ºä»€ä¹ˆæ™®é€šèŠå¤©æ²¡æœ‰è°ƒç”¨åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ - ç»¼åˆåˆ†ææŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**ç»“è®º**: æ™®é€šèŠå¤©åŠŸèƒ½**è®¾è®¡ä¸Šå°±ä¸è°ƒç”¨**åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€‚è¿™æ˜¯**æ¶æ„è®¾è®¡çš„é¢„æœŸè¡Œä¸º**ï¼Œä¸æ˜¯ bugã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„åˆ†æ

### 1. **åŒè½¨æ¶æ„è®¾è®¡**

ç³»ç»Ÿé‡‡ç”¨äº†**ä¸¤æ¡ç‹¬ç«‹çš„å¤„ç†è·¯å¾„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢ (Next.js)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                    â”‚
                    â”‚                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ™®é€šèŠå¤©è·¯å¾„        â”‚    â”‚   Research è·¯å¾„       â”‚
        â”‚  (å¿«é€Ÿã€ç®€å•)         â”‚    â”‚  (æ·±åº¦ã€å¤æ‚)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                    â”‚
                    â–¼                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  /api/chat            â”‚    â”‚  /api/research/streamâ”‚
        â”‚  (Next.js API Route)  â”‚    â”‚  (Next.js Proxy)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                            â”‚
                    â–¼                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  DeepSeek API         â”‚    â”‚  Python Backend      â”‚
        â”‚  (ç›´æ¥è°ƒç”¨)            â”‚    â”‚  (localhost:8000)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ         â”‚
                                     â”‚  - planner_agent     â”‚
                                     â”‚  - researcher_agent  â”‚
                                     â”‚  - writer_agent      â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è¯¦ç»†æŠ€æœ¯åˆ†æ

### 2. **å‰ç«¯è·¯ç”±ç»“æ„**

#### 2.1 æ™®é€šèŠå¤©è·¯ç”±

**æ–‡ä»¶**: `ai-chatbot-main/app/(chat)/api/chat/route.ts`

**å…³é”®ä»£ç **:
```typescript
// ä½¿ç”¨ AI SDK çš„ streamText ç›´æ¥è°ƒç”¨ DeepSeek
const result = streamText({
  model: myProvider.languageModel(selectedChatModel),
  system: systemPrompt({ selectedChatModel, requestHints }),
  messages: convertToModelMessages(uiMessages),
  tools: {
    createDocument: createDocument({ session, dataStream }),
    updateDocument: updateDocument({ session, dataStream }),
    requestSuggestions: requestSuggestions({ session, dataStream }),
  },
  // ... å…¶ä»–é…ç½®
});
```

**ç‰¹ç‚¹**:
- âœ… ç›´æ¥åœ¨ Next.js æœåŠ¡å™¨ç«¯è°ƒç”¨ DeepSeek API
- âœ… ä½¿ç”¨ AI SDK çš„ `streamText()` å‡½æ•°
- âœ… æ”¯æŒ tools (createDocument, updateDocument, requestSuggestions)
- âŒ **ä¸è°ƒç”¨åç«¯ Python æœåŠ¡**
- âŒ **ä¸ä½¿ç”¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ**

#### 2.2 Research è·¯ç”±

**æ–‡ä»¶**: `ai-chatbot-main/app/(chat)/api/research/stream/route.ts`

**å…³é”®ä»£ç **:
```typescript
const researchApiUrl = process.env.RESEARCH_API_URL || "http://localhost:8000";
const backendUrl = `${researchApiUrl}/research/stream`;

const upstream = await fetch(backendUrl, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Accept: "text/event-stream",
  },
  body: JSON.stringify({ prompt: prompt.trim() }),
});
```

**ç‰¹ç‚¹**:
- âœ… ä½œä¸ºä»£ç†è½¬å‘è¯·æ±‚åˆ° Python åç«¯
- âœ… è°ƒç”¨ `http://localhost:8000/api/research/stream`
- âœ… ä½¿ç”¨ SSE (Server-Sent Events) æµå¼ä¼ è¾“
- âœ… **è°ƒç”¨åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ**
- âœ… è®°å½•ç ”ç©¶ä»»åŠ¡åˆ°æ•°æ®åº“

---

### 3. **å‰ç«¯ç»„ä»¶åˆ†æ**

#### 3.1 Chat ç»„ä»¶

**æ–‡ä»¶**: `ai-chatbot-main/components/chat.tsx`

**å…³é”®é…ç½®**:
```typescript
const { messages, sendMessage, status } = useChat<ChatMessage>({
  id,
  messages: initialMessages,
  transport: new DefaultChatTransport({
    api: "/api/chat",  // â† æŒ‡å‘æ™®é€šèŠå¤©è·¯ç”±
    fetch: fetchWithErrorHandlers,
  }),
  // ...
});
```

**è¡Œä¸º**:
- ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥æ¶ˆæ¯
- ç‚¹å‡»å‘é€æŒ‰é’®
- è°ƒç”¨ `sendMessage()`
- è¯·æ±‚å‘é€åˆ° `/api/chat`
- **ä¸è§¦å‘ Research åŠŸèƒ½**

#### 3.2 Research Panel ç»„ä»¶

**æ–‡ä»¶**: `ai-chatbot-main/components/research-panel.tsx`

**è§¦å‘æ¡ä»¶**:
```typescript
// åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ˜¾ç¤º Research Panel:
const hasPrompt = Boolean(prompt?.trim().length);
const shouldShow = hasPrompt || isActive || status !== "idle";

// Research Button åªåœ¨ä»¥ä¸‹æƒ…å†µæ˜¾ç¤º:
{!isActive && status === "idle" && hasPrompt && (
  <ResearchButton
    onStart={onStart}  // â† ç”¨æˆ·ç‚¹å‡»åæ‰è§¦å‘
    prompt={prompt}
  />
)}
```

**è§¦å‘æ–¹å¼**:
1. **è‡ªåŠ¨æ£€æµ‹**: AI åœ¨å›å¤ä¸­å»ºè®®è¿›è¡Œç ”ç©¶
2. **æ‰‹åŠ¨è§¦å‘**: ç”¨æˆ·ç‚¹å‡» "Start Research" æŒ‰é’®
3. **æ˜¾å¼è°ƒç”¨**: ç”¨æˆ·ç‚¹å‡» "Research This Topic" æŒ‰é’®

---

### 4. **åç«¯ API ç«¯ç‚¹åˆ†æ**

#### 4.1 åç«¯ Research ç«¯ç‚¹

**æ–‡ä»¶**: `main.py`

**ç«¯ç‚¹**: `POST /api/research/stream`

**åŠŸèƒ½**:
```python
@app.post("/api/research/stream")
async def research_stream(request: ResearchRequest):
    """
    SSE æµå¼ç ”ç©¶æ¥å£
    
    å·¥ä½œæµç¨‹ï¼š
    1. å‘é€ START äº‹ä»¶
    2. è°ƒç”¨ planner_agent ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
    3. å‘é€ PLAN äº‹ä»¶
    4. å¾ªç¯æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼š
       - è°ƒç”¨ researcher_agent
       - è°ƒç”¨ writer_agent
    5. å‘é€ DONE äº‹ä»¶
    """
```

**å¤šæ™ºèƒ½ä½“è°ƒç”¨é“¾**:
```
research_stream()
  â†“
planner_agent()  # ç”Ÿæˆç ”ç©¶è®¡åˆ’
  â†“
executor_agent_step()  # æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
  â†“
researcher_agent()  # æœç´¢å’Œåˆ†æ
  â†“
writer_agent()  # ç”ŸæˆæŠ¥å‘Š
```

---

## ğŸ“Š æ•°æ®æµå¯¹æ¯”

### æ™®é€šèŠå¤©æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ "ä½ å¥½"
  â†“
MultimodalInput ç»„ä»¶
  â†“
useChat hook
  â†“
POST /api/chat (Next.js)
  â†“
streamText() with DeepSeek
  â†“
ç›´æ¥è¿”å› AI å“åº”
  â†“
æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢
```

**è€—æ—¶**: ~2-5 ç§’
**è°ƒç”¨**: DeepSeek API (1 æ¬¡)
**åç«¯**: ä¸æ¶‰åŠ

### Research æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡» "Start Research"
  â†“
ResearchButton ç»„ä»¶
  â†“
useResearchProgress hook
  â†“
POST /api/research/stream (Next.js Proxy)
  â†“
POST http://localhost:8000/api/research/stream (Python)
  â†“
planner_agent â†’ researcher_agent â†’ writer_agent
  â†“
SSE æµå¼è¿”å›è¿›åº¦å’Œç»“æœ
  â†“
æ˜¾ç¤ºåœ¨ ResearchProgress ç»„ä»¶
```

**è€—æ—¶**: ~30-120 ç§’
**è°ƒç”¨**: DeepSeek API (å¤šæ¬¡), Tavily API (å¤šæ¬¡)
**åç«¯**: Python FastAPI + å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ

---

## ğŸ¯ è®¾è®¡åŸç†åˆ†æ

### ä¸ºä»€ä¹ˆé‡‡ç”¨åŒè½¨æ¶æ„ï¼Ÿ

#### 1. **æ€§èƒ½ä¼˜åŒ–**

| ç»´åº¦ | æ™®é€šèŠå¤© | Research |
|------|---------|----------|
| å“åº”æ—¶é—´ | 2-5 ç§’ | 30-120 ç§’ |
| API è°ƒç”¨ | 1 æ¬¡ | 5-15 æ¬¡ |
| æˆæœ¬ | ä½ | é«˜ |
| å¤æ‚åº¦ | ç®€å• | å¤æ‚ |

**ç»“è®º**: å¤§éƒ¨åˆ†ç”¨æˆ·æŸ¥è¯¢ä¸éœ€è¦æ·±åº¦ç ”ç©¶ï¼Œç›´æ¥è°ƒç”¨ AI å³å¯æ»¡è¶³éœ€æ±‚ã€‚

#### 2. **ç”¨æˆ·ä½“éªŒ**

- **æ™®é€šèŠå¤©**: å¿«é€Ÿå“åº”ï¼Œé€‚åˆç®€å•é—®ç­”
- **Research**: æ·±åº¦åˆ†æï¼Œé€‚åˆå¤æ‚ä¸»é¢˜

#### 3. **æˆæœ¬æ§åˆ¶**

- **æ™®é€šèŠå¤©**: 1 æ¬¡ API è°ƒç”¨ = ~$0.001
- **Research**: 10+ æ¬¡ API è°ƒç”¨ = ~$0.01-0.05

**ç»“è®º**: åªåœ¨å¿…è¦æ—¶ä½¿ç”¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼Œé™ä½è¿è¥æˆæœ¬ã€‚

#### 4. **æ¶æ„çµæ´»æ€§**

- **æ™®é€šèŠå¤©**: å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸ä¾èµ– Python åç«¯
- **Research**: å¯ä»¥ç‹¬ç«‹æ‰©å±•ï¼Œä¸å½±å“æ™®é€šèŠå¤©

---

## ğŸ”¬ æ—¥å¿—éªŒè¯

### æ™®é€šèŠå¤©æ—¥å¿—

**å‰ç«¯æ—¥å¿—** (`logs/frontend.log`):
```
POST /api/chat 200 in 62563ms
GET /api/history?limit=20 200 in 687ms
GET /api/vote?chatId=... 200 in 1768ms
```

**åç«¯æ—¥å¿—** (`logs/backend.log`):
```
INFO: Started server process [40306]
INFO: Application startup complete.
INFO: 127.0.0.1:58950 - "GET /health HTTP/1.1" 200 OK
```

**ç»“è®º**: 
- âœ… å‰ç«¯è°ƒç”¨äº† `/api/chat`
- âŒ åç«¯æ²¡æœ‰æ”¶åˆ°ä»»ä½•è¯·æ±‚
- âœ… è¿™æ˜¯**é¢„æœŸè¡Œä¸º**

### Research æ—¥å¿—ï¼ˆé¢„æœŸï¼‰

**å‰ç«¯æ—¥å¿—**:
```
POST /api/research/stream 200 in 45000ms
```

**åç«¯æ—¥å¿—**:
```
INFO: ğŸš€ SSE æµå¼ç ”ç©¶è¯·æ±‚: React å‘å±•å†å²...
INFO: ğŸ“¤ å‘é€ START äº‹ä»¶
INFO: ğŸ§  è°ƒç”¨ planner_agent ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
INFO: ğŸ“¡ è°ƒç”¨ deepseek:deepseek-reasoner API
HTTP Request: POST https://api.deepseek.com/chat/completions "HTTP/1.1 200 OK"
INFO: ğŸ“¤ å‘é€ PLAN äº‹ä»¶
INFO: ğŸ” æ‰§è¡Œæ­¥éª¤ 1/3: æœç´¢ React å†å²èµ„æ–™
INFO: ğŸ“¡ è°ƒç”¨ researcher_agent
...
```

---

## ğŸ“‹ åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | æ™®é€šèŠå¤© | Research |
|------|---------|----------|
| **è§¦å‘æ–¹å¼** | ç›´æ¥å‘é€æ¶ˆæ¯ | ç‚¹å‡» "Start Research" |
| **å‰ç«¯è·¯ç”±** | `/api/chat` | `/api/research/stream` |
| **åç«¯è°ƒç”¨** | âŒ ä¸è°ƒç”¨ | âœ… è°ƒç”¨ Python åç«¯ |
| **å¤šæ™ºèƒ½ä½“** | âŒ ä¸ä½¿ç”¨ | âœ… ä½¿ç”¨ (planner + researcher + writer) |
| **API è°ƒç”¨** | DeepSeek (1 æ¬¡) | DeepSeek (å¤šæ¬¡) + Tavily (å¤šæ¬¡) |
| **å“åº”æ—¶é—´** | 2-5 ç§’ | 30-120 ç§’ |
| **æµå¼è¾“å‡º** | âœ… æ”¯æŒ | âœ… æ”¯æŒ (SSE) |
| **æ•°æ®åº“è®°å½•** | âœ… èŠå¤©å†å² | âœ… èŠå¤©å†å² + ç ”ç©¶ä»»åŠ¡ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•é—®ç­”ã€å¯¹è¯ | æ·±åº¦ç ”ç©¶ã€æŠ¥å‘Šç”Ÿæˆ |

---

## ğŸ¯ ç»“è®º

### æ ¸å¿ƒå‘ç°

1. **è¿™ä¸æ˜¯ bugï¼Œæ˜¯è®¾è®¡ç‰¹æ€§**
   - æ™®é€šèŠå¤©å’Œ Research æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„åŠŸèƒ½
   - å„è‡ªæœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯å’Œæ€§èƒ½ç‰¹ç‚¹

2. **æ™®é€šèŠå¤©çš„è®¾è®¡ç›®æ ‡**
   - å¿«é€Ÿå“åº”
   - ä½æˆæœ¬
   - ç®€å•éƒ¨ç½²
   - ä¸éœ€è¦åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ

3. **Research åŠŸèƒ½çš„è®¾è®¡ç›®æ ‡**
   - æ·±åº¦åˆ†æ
   - å¤šæºä¿¡æ¯æ•´åˆ
   - ç»“æ„åŒ–æŠ¥å‘Š
   - éœ€è¦åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ

### éªŒè¯æ–¹æ³•

è¦éªŒè¯åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œéœ€è¦ï¼š

1. âœ… ç‚¹å‡» "Start Research" æŒ‰é’®
2. âœ… è¾“å…¥ç ”ç©¶ä¸»é¢˜
3. âœ… è§‚å¯Ÿåç«¯æ—¥å¿—ä¸­çš„å¤šæ™ºèƒ½ä½“è°ƒç”¨é“¾
4. âœ… æŸ¥çœ‹ SSE äº‹ä»¶æµ

**ä¸åº”è¯¥æœŸæœ›**æ™®é€šèŠå¤©è°ƒç”¨åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€‚

---

## ğŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### å‰ç«¯æ–‡ä»¶
- `ai-chatbot-main/app/(chat)/api/chat/route.ts` - æ™®é€šèŠå¤©è·¯ç”±
- `ai-chatbot-main/app/(chat)/api/research/stream/route.ts` - Research ä»£ç†è·¯ç”±
- `ai-chatbot-main/components/chat.tsx` - ä¸»èŠå¤©ç»„ä»¶
- `ai-chatbot-main/components/research-panel.tsx` - Research é¢æ¿
- `ai-chatbot-main/hooks/use-research-progress.ts` - Research hook

### åç«¯æ–‡ä»¶
- `main.py` - FastAPI ä¸»æ–‡ä»¶ï¼ŒåŒ…å« `/api/research/stream` ç«¯ç‚¹
- `src/agents/planner_agent.py` - è§„åˆ’æ™ºèƒ½ä½“
- `src/agents/researcher_agent.py` - ç ”ç©¶æ™ºèƒ½ä½“
- `src/agents/writer_agent.py` - å†™ä½œæ™ºèƒ½ä½“

### é…ç½®æ–‡ä»¶
- `ai-chatbot-main/lib/ai/providers.ts` - DeepSeek provider é…ç½®
- `ai-chatbot-main/.env.local` - å‰ç«¯ç¯å¢ƒå˜é‡
- `.env` - åç«¯ç¯å¢ƒå˜é‡

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

å¦‚æœä½ æƒ³æµ‹è¯•åç«¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼š

1. **ä½¿ç”¨ Research åŠŸèƒ½**
   - åœ¨èŠå¤©ç•Œé¢ç‚¹å‡» "Research This Topic"
   - æˆ–è€…ç‚¹å‡» "Start Research" æŒ‰é’®

2. **ç›‘æ§åç«¯æ—¥å¿—**
   ```bash
   tail -f logs/backend.log
   ```

3. **è§‚å¯Ÿå¤šæ™ºèƒ½ä½“è°ƒç”¨é“¾**
   - planner_agent ç”Ÿæˆè®¡åˆ’
   - researcher_agent æœç´¢ä¿¡æ¯
   - writer_agent ç”ŸæˆæŠ¥å‘Š

4. **éªŒè¯ SSE äº‹ä»¶æµ**
   - start â†’ plan â†’ progress â†’ done

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-01 23:30
**åˆ†æå·¥å…·**: Kiro AI Assistant
**ç³»ç»Ÿç‰ˆæœ¬**: Phase 3 (Next.js Frontend Integration)
