flowchart TD
    Start([Agent 调用 API]) --> Check{检查 max_tokens}
    Check -->|在限制内| Direct[直接调用 API]
    Check -->|超过限制| Adjust[自动调整为模型限制值]
    
    Adjust --> Log[记录警告日志]
    Log --> Try1[第一次尝试]
    
    Try1 -->|成功| Success([返回结果])
    Try1 -->|失败| Retry{是否参数错误?}
    
    Retry -->|是| Halve[max_tokens 减半]
    Retry -->|否| Fallback[降级到备用模型]
    
    Halve --> Try2[第二次尝试]
    Try2 -->|成功| Success
    Try2 -->|失败| Fallback
    
    Fallback --> Try3[使用 OpenAI]
    Try3 --> Success
    
    Direct --> Success
    
    style Start fill:#e1f5ff
    style Success fill:#c8e6c9
    style Adjust fill:#fff9c4
    style Fallback fill:#ffccbc
